---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import OptimizedHeroImage from '../components/OptimizedHeroImage.astro';
import { generateHeroPreload } from '../utils/heroImagePreload';

const allPosts = (await getCollection('blog')) || [];
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year for timeline effect
const postsByYear: Record<number, typeof sortedPosts> = sortedPosts.reduce(
  (acc, post) => {
    const year = new Date(post.data.pubDate).getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof sortedPosts>
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

// 첫 번째 포스트의 hero 이미지 preload용
const firstPost = sortedPosts[0];
const sizes = '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 396px';

const firstPostPreloadData = firstPost?.data.heroImage
  ? await generateHeroPreload({
      slug: firstPost.slug,
      heroImage: firstPost.data.heroImage,
      sizes,
    })
  : null;
---

<Layout title="Blog - JK.dev">
  <!-- 첫 번째 포스트의 hero 이미지 preload -->
  {
    firstPostPreloadData && (
      <link
        slot="hero-preload"
        rel="preload"
        as="image"
        href={firstPostPreloadData.href}
        imagesizes={firstPostPreloadData.imagesizes}
        imagesrcset={firstPostPreloadData.imagessrcset}
      />
    )
  }
  <div class="mx-auto w-full max-w-6xl px-4 py-10 sm:px-6 sm:py-16">
    <!-- Enhanced header with search - improved responsive spacing -->
    <div class="relative mb-12 sm:mb-20">
      <!-- Decorative elements - adjusted for better mobile appearance -->
      <div
        class="animate-blob absolute -left-10 -top-10 h-48 w-48 rounded-full bg-zinc-100 opacity-30 blur-3xl dark:bg-zinc-800/30 sm:-left-20 sm:-top-20 sm:h-72 sm:w-72"
      >
      </div>
      <div
        class="animate-blob animation-delay-2000 absolute -bottom-10 -right-10 h-48 w-48 rounded-full bg-zinc-200 opacity-30 blur-3xl dark:bg-zinc-800/30 sm:-bottom-20 sm:-right-20 sm:h-72 sm:w-72"
      >
      </div>

      <div class="relative text-center">
        <h1
          class="mb-4 text-3xl font-bold tracking-tight text-zinc-900 dark:text-zinc-100 sm:text-4xl md:text-5xl"
        >
          Posts
        </h1>

        <p
          class="mx-auto mb-6 max-w-2xl text-sm text-zinc-600 dark:text-zinc-400 sm:mb-10 sm:text-base"
        >
          전체 글 목록을 확인해보세요
        </p>
      </div>
    </div>
    <!-- Improved grid layout for better mobile experience -->
    <div class="grid grid-cols-1 gap-6 sm:gap-8 md:grid-cols-12">
      <!-- Featured post (if exists) - improved mobile layout -->
      {
        sortedPosts.length > 0 && (
          <div class="mb-8 sm:mb-12 md:col-span-12">
            <article class="group relative overflow-hidden rounded-none border-b border-zinc-200 pb-6 dark:border-zinc-800 sm:pb-8">
              <div class="flex h-full flex-col gap-6 sm:gap-8 md:flex-row">
                {sortedPosts[0].data.heroImage && (
                  <div class="mx-auto h-60 w-full max-w-full overflow-hidden bg-zinc-100 dark:bg-zinc-900 sm:h-80 sm:max-w-md md:mx-0 md:h-96 md:w-1/2">
                    <OptimizedHeroImage
                      slug={sortedPosts[0].slug}
                      heroImage={sortedPosts[0].data.heroImage}
                      title={sortedPosts[0].data.title}
                      class="h-full w-full object-contain transition-all duration-700 group-hover:scale-105"
                      sizes={sizes}
                      fetchpriority="high"
                      loading="eager"
                      decoding="async"
                    />
                  </div>
                )}

                <div class="flex flex-1 flex-col justify-center">
                  <div class="mb-3 flex items-center justify-center gap-2 text-xs text-zinc-500 dark:text-zinc-400 sm:text-sm md:justify-start">
                    <span class="font-medium uppercase tracking-wider">추천</span>
                    <span class="h-px w-6 bg-zinc-300 dark:bg-zinc-700 sm:w-8" />
                    {sortedPosts[0].data.pubDate && (
                      <time datetime={sortedPosts[0].data.pubDate.toISOString()}>
                        {sortedPosts[0].data.pubDate.toLocaleDateString('ko-KR', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })}
                      </time>
                    )}
                  </div>

                  <h2 class="mb-3 text-center text-2xl font-bold text-zinc-900 transition-colors group-hover:text-zinc-700 dark:text-zinc-100 dark:group-hover:text-zinc-300 sm:mb-4 sm:text-3xl md:text-left">
                    <a
                      href={`/blog/${sortedPosts[0].slug}/`}
                      class="before:absolute before:inset-0"
                    >
                      {sortedPosts[0].data.title}
                    </a>
                  </h2>

                  <p class="mb-4 line-clamp-3 text-center text-sm text-zinc-600 dark:text-zinc-400 sm:mb-6 sm:text-base md:text-left">
                    {sortedPosts[0].data.description}
                  </p>

                  <div class="flex flex-wrap items-center justify-center gap-3 sm:gap-4 md:justify-start">
                    {sortedPosts[0].data.tags && (
                      <div class="flex flex-wrap justify-center gap-2 md:justify-start">
                        {sortedPosts[0].data.tags.slice(0, 2).map((tag) => (
                          <span class="border border-zinc-200 px-2 py-1 text-xs uppercase tracking-wider text-zinc-600 dark:border-zinc-800 dark:text-zinc-400 sm:px-3">
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </article>
          </div>
        )
      }

      <!-- Improved sidebar for mobile -->
      <div class="relative md:col-span-3">
        <div class="mb-8 space-y-4 md:sticky md:top-24 md:mb-0">
          <h3
            class="mb-4 text-center text-lg font-medium uppercase tracking-wider text-zinc-900 dark:text-zinc-100 md:text-left"
          >
            보관함
          </h3>

          <!-- Horizontal scrollable archive on mobile, vertical on desktop -->
          <div
            class="hide-scrollbar flex overflow-x-auto pb-4 md:flex-col md:overflow-visible md:pb-0"
          >
            {
              years.map((year, index) => (
                <a
                  href={`#year-${year}`}
                  class={`mr-3 flex items-center whitespace-nowrap rounded-full border-b border-zinc-100 px-4 py-2 transition-colors hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-900 md:mr-0 md:w-full md:whitespace-normal md:rounded-none md:px-0 md:py-3 ${index === 0 ? 'bg-zinc-50 dark:bg-zinc-800/50' : ''}`}
                >
                  <span class="text-base font-medium text-zinc-900 dark:text-zinc-100 md:text-lg">
                    {year}
                  </span>
                  <span class="ml-2 text-xs text-zinc-500 dark:text-zinc-400 md:ml-auto md:text-sm">
                    {postsByYear[year].length} post{postsByYear[year].length !== 1 ? 's' : ''}
                  </span>
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Improved post grid for mobile -->
      <div class="md:col-span-9">
        {
          years.map((year) => (
            <div id={`year-${year}`} class="mb-12 scroll-mt-16 sm:mb-20">
              <h2 class="mb-6 border-b border-zinc-200 pb-3 text-center text-xl font-bold text-zinc-900 dark:border-zinc-800 dark:text-zinc-100 sm:mb-8 sm:pb-4 sm:text-2xl md:text-left">
                {year}
              </h2>

              <div
                class={`grid grid-cols-1 ${postsByYear[year].length >= 2 ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-8 sm:gap-12`}
              >
                {postsByYear[year].map((post) => (
                  <article class="group relative mx-auto flex h-full w-full max-w-sm flex-col sm:max-w-md md:mx-0">
                    {post.data.heroImage && (
                      <div class="mb-4 h-48 overflow-hidden rounded-lg bg-zinc-100 dark:bg-zinc-900 sm:h-56">
                        <OptimizedHeroImage
                          slug={post.slug}
                          heroImage={post.data.heroImage}
                          title={post.data.title}
                          class="h-full w-full object-contain transition-all duration-700 group-hover:scale-105"
                          sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 396px"
                        />
                      </div>
                    )}

                    <div class="flex flex-1 flex-col">
                      <div class="mb-2 flex flex-wrap items-center justify-center gap-3 text-xs text-zinc-500 dark:text-zinc-400 sm:mb-3 sm:gap-4 sm:text-sm md:justify-start">
                        {post.data.pubDate && (
                          <time
                            datetime={post.data.pubDate.toISOString()}
                            class="flex items-center"
                          >
                            {post.data.pubDate.toLocaleDateString('ko-KR', {
                              month: 'short',
                              day: 'numeric',
                            })}
                          </time>
                        )}
                      </div>

                      <h3 class="mb-2 text-center text-lg font-semibold text-zinc-900 transition-colors group-hover:text-zinc-700 dark:text-zinc-100 dark:group-hover:text-zinc-300 sm:mb-3 sm:text-xl md:text-left">
                        <a href={`/blog/${post.slug}/`} class="before:absolute before:inset-0">
                          {post.data.title}
                        </a>
                      </h3>

                      <p class="mb-4 line-clamp-2 flex-grow text-center text-sm text-zinc-600 dark:text-zinc-400 md:text-left">
                        {post.data.description}
                      </p>

                      {post.data.tags && (
                        <div class="mt-auto flex flex-wrap justify-center gap-2 md:justify-start">
                          {post.data.tags.slice(0, 2).map((tag) => (
                            <span class="border border-zinc-200 px-2 py-1 text-xs uppercase tracking-wider text-zinc-600 dark:border-zinc-800 dark:text-zinc-400 sm:px-3">
                              {tag}
                            </span>
                          ))}
                          {post.data.tags.length > 2 && (
                            <span class="border border-zinc-200 px-2 py-1 text-xs uppercase tracking-wider text-zinc-600 dark:border-zinc-800 dark:text-zinc-400 sm:px-3">
                              +{post.data.tags.length - 2}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </article>
                ))}
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Blob animation */
  .animate-blob {
    animation: blob-bounce 8s infinite ease;
  }

  .animation-delay-2000 {
    animation-delay: 2s;
  }

  @keyframes blob-bounce {
    0%,
    100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(5%, 5%) scale(1.05);
    }
    50% {
      transform: translate(0, 10%) scale(1);
    }
    75% {
      transform: translate(-5%, 5%) scale(0.95);
    }
  }

  /* Search container hover effect */
  .search-container:hover .search-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
  }

  /* Input focus animation */
  input:focus + div .search-pulse {
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Hide scrollbar but keep functionality */
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  /* Line clamp for descriptions */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Improved touch targets for mobile */
  @media (max-width: 640px) {
    a,
    button {
      min-height: 44px;
      display: flex;
      align-items: center;
    }
  }
</style>

<script>
  // Optimized index page interactions
  document.addEventListener('DOMContentLoaded', () => {
    // Smooth scrolling for year links
    document.querySelectorAll('a[href^="#year-"]').forEach((anchor) => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetElement = document.querySelector(this.getAttribute('href') || '');
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  });
</script>
